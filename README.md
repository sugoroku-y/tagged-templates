# tagged-templates

タグ付きテンプレートをいくつか用意しました。

## `indented`

テンプレート文字列の中からインデントを取り除くタグ付きテンプレートです。

以下のように使用します。

```ts
import { indented } from 'tagged-templates';

const result = indented`
  This is a
   multiline
   string with
   some indentations
  `;
// -> 'This is a multiline string with some indentations'
```

このように、`indented`をテンプレートタグとして使用すると、テンプレート文字列の各行から先頭のインデントを取り除いた文字列が返されます。

このとき取り除くインデントは終端の`` ` ``の前にある空白もしくはタブです。

終端の`` ` ``の前の空白やタブ、およびその前の改行文字は取り除かれます。

先頭は改行で始めてください。この改行も取り除かれます。

テンプレート文字列中で折り返したいけど、文字列中に改行を入れたくない、という場合は、行末にバックスラッシュを置くことで、改行を挿入しないようにできます。

```ts
const result = indented`
  This line \
  continues here \
  and does not have \
  its indent removed
  `;
```

### 書式

`indented`で使用されるテンプレート文字列は以下の書式で記述する必要があります。

- 末尾の`` ` ``から行頭までにある空白もしくはタブがインデントと見なされる。
- 末尾の`` ` ``から行頭までには空白もしくはタブ以外の文字が存在しないこと
- 先頭の`` ` ``の後の文字は改行であること
- 各行は空行、もしくは行頭がインデントで始まっていること。
- エスケープ文字は通常のテンプレートリテラルと同じものが使用できます。改行の前に`\`があるとその改行は取り除かれます。

### バリエーション

- `indented.raw`

  エスケープ文字をそのまま文字列として展開する`indented.raw`を用意しています。

  `\`をそのまま文字として利用したい場合にはこちらを使ってください。

- `indented.safe`

  ほぼ`indented`と同じですが書式やエスケープシーケンスが不正な場合でも例外を投げません。

  書式が不正な場合は通常のテンプレートリテラルと同様にインデントの除去を行いません。

  エスケープシーケンスが不正な場合は`\`を除去するだけになります。

  例外処理注など別の例外を投げるわけにはいかないときにはこちらを使ってください。

## `error`

テンプレート文字列を用いて生成したメッセージを持つ例外を throw するタグ付きテンプレートです。

以下のように使用します。

```ts
const type =
  value === 'aaa'
    ? 'typeA'
    : value === 'bbb'
    ? 'typeB'
    : error`Unknown value: ${value}`;
```

`error`の返値は`never`型になっているため、3 項演算子などで想定外の値を除外することができます。

また、`error.for()`を使用することで、throw する例外クラスを指定できます。以下は `SyntaxError` を throw する例です。

```ts
error.for(SyntaxError)`
  Invalid Unicode character
  ${line}
  ${' '.repeat(col)}^
  `;
```

### メッセージの生成

メッセージは`indented.safe`を使用して生成されるため、改行を入れたい場合には例のようにインデントした状態で記述できます。

改行を入れなければ通常のテンプレートリテラルとほぼ同様にメッセージを生成します。

## `regexp`

指定されたテンプレート文字列を元に正規表現オブジェクトを作成するタグ付きテンプレートです。

以下のように使用します。

```ts
const pattern = regexp`^[a-z]+$`;
```

このように、テンプレート文字列に正規表現のパターンを記述して渡すことで、正規表現オブジェクトが生成されます。

このタグ付きテンプレート内ではエスケープ文字が処理されないため、`\s`のような`\`を含む正規表現をあつかう際にいちいちエスケープする必要はありません。

```ts
const pattern = regexp`^([a-z]+(?:-[a-z]+)*)\s*=\s*(\d+)$`;
```

### 変数を埋め込む

テンプレート文字列では、値を `${}` で囲んで埋め込むことができます。`regexp` 関数でも同様に、値を埋め込んだ正規表現を生成することができます。

```ts
const username = 'user123';
const pattern = regexp`^${username}[0-9]*$`;
```

`regexp`で埋め込める値には以下の 3 とおりあります。

- 文字列値

  文字列値が埋め込まれる場合には正規表現の特殊文字はすべてエスケープして埋め込まれます。

  ```ts
  const address = 'yebisuya@gmail.com`;
  const pattern = regexp`^From: ${address}$`;
  // -> /^From: yebisuya@gmail\.com$/
  ```

- 正規表現

  正規表現を埋め込む場合は、その正規表現のパターンそのものが埋め込まれます。

  ただし前後に影響を与えないように`(?:～)`で囲まれて挿入されます。

  指定した正規表現にフラグが指定されていた場合、そのフラグ指定がマージされます。

  ```ts
  const ALPHABET = /[A-Z]/i;
  const WORD = regexp`${ALPHABET}+`;
  // -> /(?:[A-Z])+/i
  ```

- フラグ指定オブジェクト

  `flags`という名前のプロパティを持つオブジェクトが指定されると、その`flags`プロパティに指定されたフラグがマージされますが、生成される正規表現のパターンには何も影響を与えません。

  ```ts
  const UPPERCASE = /[A-Z]/;
  const WORD = regexp`${UPPERCASE}+${{ flags: 'i' }}`;
  // -> /(?:[A-Z])+/i
  ```

### フラグを指定する

生成される正規表現には埋め込まれた正規表現やフラグ指定オブジェクトで指定されている`flags`プロパティをマージしたものが指定されます。

複数の正規表現を埋め込む場合にはそれぞれの正規表現に指定されたフラグがマージされるので、想定した挙動にならない可能性があります。

```ts
const GLOBAL = /\w+/g;
const IGNORECASE /[A-Z]/i;
const pattern = regexp`${GLOBAL}\s*=\s*=${IGNORECASE}+`;
// -> /(?:\w+)\s*=\s*=(?:[A-Z])+/gi
```

### 空白

テンプレートに指定された文字列のうち空白は以下のように扱われます。

- エスケープされた空白はそのまま
- 改行と隣接した空白やタブは除去
- 改行と隣接しない空白やタブは一つの空白に置換

```ts
const pattern = regexp`
  abc def    ghi
  \ jkl mno
  \ pqr stu vwx yz
  `; // -> /abc def ghi jkl mno pqr stu vwx yz/
```

### コメント

1 行コメント(`//`から改行まで)やブロックコメント(`/*`から`*/`まで)が指定できます。

ただし、`/`や`*`がエスケープされているとコメントとは見なされません。

また途中に`${～}`があると 1 行コメントはそこで終了、ブロックコメントはコメントと見なされなくなるので注意してください。

```ts
const pattern = regexp`
   // 1行コメント
   [A-Za-z_][A-Za-z_0-9]*
   /* ブロックコメント */
   \s*=\s*(?:\S(?:.*\S)?)?\s*
   // 1行コメントの途中: ${''}ここからはコメントにならない
   /* ブロックコメントの途中: ${''} このブロック全体がコメントにならない */
`;
```

### VS Code の拡張

VS Code でこのタグ付きテンプレートを使う場合は`Comment tagged template`をインストールすることをおすすめします。

この拡張をインストールした上で、以下のように記述すると

```ts
const pattern = regexp/* regexp */ `
   [A-Za-z_][A-Za-z_0-9]*
`;
```

テンプレート内の文字列が正規表現のシンタックスで色付けされるので便利です。
